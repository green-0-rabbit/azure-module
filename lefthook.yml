pre-commit:
  parallel: false
  jobs:
    - name: terraform fmt
      glob: "*.tf"
      run: just tf-fmt

    - name: terraform validate changed modules
      glob: "*.tf"
      run: |
        set -euo pipefail

        modules="$(printf '%s\n' {staged_files} | awk -F/ 'NF > 1 {print $1}' | sort -u)"

        if [ -z "$modules" ]; then
          echo "No staged Terraform module changes detected."
          exit 0
        fi

        while IFS= read -r module; do
          [ -z "$module" ] && continue
          echo "Initializing and validating module: $module"
          just tf-init "$module"
          just tf-validate "$module"
        done <<EOF
$modules
EOF
