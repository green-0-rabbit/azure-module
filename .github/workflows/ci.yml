name: Continuous Integration

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  detect-modules:
    name: Detect Changed Modules
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.build-matrix.outputs.matrix }}
      has_changes: ${{ steps.build-matrix.outputs.has_changes }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed Terraform module directories
        id: changed-modules
        uses: tj-actions/changed-files@v47
        with:
          dir_names: true
          dir_names_max_depth: 1
          files: |
            **/*.tf
          separator: "\n"

      - name: Build module matrix from changed files
        id: build-matrix
        shell: bash
        run: |
          set -euo pipefail
          raw_modules="${{ steps.changed-modules.outputs.all_changed_files }}"

          mapfile -t modules < <(
            printf '%s' "$raw_modules" \
              | sed -e 's/\\n/\n/g' -e 's/,/\n/g' -e 's/[[:space:]]\+/\n/g' \
              | sed '/^$/d' \
              | awk '!seen[$0]++' \
              | while read -r module; do
                  [[ -d "$module" ]] && echo "$module"
                done
          )

          if (( ${#modules[@]} > 0 )); then
            matrix="$(printf '%s\n' "${modules[@]}" | jq -R . | jq -cs '{ include: map({ env: . }) }')"
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          else
            matrix='{"include":[]}'
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          fi

          echo "matrix=$matrix" >> "$GITHUB_OUTPUT"

  terraform-validation:
    name: Terraform Validation
    needs: detect-modules
    if: needs.detect-modules.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.detect-modules.outputs.matrix) }}
    defaults:
      run:
        working-directory: "${{ matrix.env }}"
    steps:
      - name: Checkout
        id: checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        id: setup-terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      - name: Terraform Format
        run: terraform fmt -check

      - name: Terraform Init
        run: terraform init

      - name: Terraform Validate
        run: terraform validate -no-color